# Maintainer: Damian Nowak <spam@nowaker.net>
# Contributor: Sebastien Leduc <sebastien@sleduc.fr>
# Contributor: Shanto <shanto@hotmail.com>

pkgname='archipel-agent-nightly'
pkgver='0'
pkgrel='3'
pkgdesc='A solution to manage and supervise virtual machines. (Agent)'
arch=(any)
url='http://archipelproject.org/'
license=('AGPL')
depends=(
  'python2' 'python2-apscheduler' 'python2-sqlalchemy'
  'python2-numpy' 'python2-magic' 'python2-ctypes'
  'python-imaging' 'xmpppy'
  'libvirt' 'qemu'
)
makedepends=('wget')
conflicts=('archipel-agent')
options=(!strip !emptydirs)
install='archipel-agent.install'
source=('archipel.service')
md5sums=('e72f5f200c0a8dfc5a23e99099c85396')

package() {
  cd "$srcdir"
  if [ ! -f 'archipel.tar.gz' ]; then
    wget 'http://nightlies.archipelproject.org/latest-archipel-agent.tar.gz' -O 'archipel.tar.gz'
    tar -xf 'archipel.tar.gz'
  fi  

  cd `find "$srcdir" -type d -name ArchipelAgent -print -quit`

  _file='archipel-agent/install/bin/archipel-initinstall'

  sed -i \
      's/etc\/init\.d/etc\/rc.d/' \
      "${_file}"

  sed -i \
      's/resource_filename(Requirement\.parse("archipel-agent"),"/("\/usr\/share\/archipel\//' \
      "${_file}"

  for mod in archipel-core archipel-agent-* archipel-agent; do
    pushd $mod 1>/dev/null
    python2 setup.py install --root="$pkgdir/" --optimize=1
    popd 1>/dev/null
  done;

  _datadir="$pkgdir"/usr/share/archipel
  mkdir -p "$_datadir"
  mv "$pkgdir/usr/install" "$_datadir"/

  cd "$srcdir"
  install -D -m644 archipel.service "$pkgdir/usr/lib/systemd/system/archipel.service"
}
