# Maintainer: Damian Nowak <damian.nowak@atlashost.eu>
# Contributor: Allan McRae <allan@archlinux.org>
# Contributor: judd <jvinet@zeroflux.org>

pkgname=coreutils-static
pkgver=8.21
pkgrel=3
pkgdesc="The basic file, shell and text manipulation utilities of the GNU operating system"
arch=('i686' 'x86_64')
license=('GPL3')
url="http://www.gnu.org/software/coreutils"
groups=('base')
depends=()
install=coreutils.install
source=(ftp://ftp.gnu.org/gnu/coreutils/coreutils-$pkgver.tar.xz{,.sig}
        'attr.PKGBUILD::https://projects.archlinux.org/svntogit/packages.git/plain/trunk/PKGBUILD?h=packages/attr'
        'libcap.PKGBUILD::https://projects.archlinux.org/svntogit/packages.git/plain/trunk/PKGBUILD?h=packages/libcap')
md5sums=('065ba41828644eca5dd8163446de5d64'
         'SKIP'
         '6bddfb18346d962ccadd6dd3b68b53a8'
         'f7e4906dfd74af5343eec94f87b279b4')


build() {
  libs=''

  cd ${srcdir}
  for file in ./*.PKGBUILD; do
    cd ${srcdir}
    name="${file%.PKGBUILD}"
    mkdir -p "$name"
    mv "$file" "$name/PKGBUILD"
    cd "$name"
    makepkg -f
    staticlibdirs=$(find "`pwd`" -name '*.a' -printf "%h\n" | sort -u)
    for staticlibdir in $staticlibdirs; do
       libs="$libs -L$staticlibdir"
    done
  done

  cd ${srcdir}/coreutils-${pkgver}

  sed -i '/elf_sys=yes/s:yes:no:' configure # https://bugs.gentoo.org/show_bug.cgi?id=321821
  ./configure --prefix=/rescue --libexecdir=/usr/lib \
              --enable-no-install-program=groups,hostname,kill,uptime \
              --disable-nls 

  make CC="gcc -static -std=gnu99 ${libs}"
}

check() {
  cd ${srcdir}/coreutils-${pkgver}

  # This test fails, `id -G user` coredumps
  sed -i 's/fail=1/fail=0/' tests/misc/id-groups.sh 

  make RUN_EXPENSIVE_TESTS=yes check
}

package() {
  cd ${srcdir}/coreutils-${pkgver}
  make DESTDIR=${pkgdir} install
}
